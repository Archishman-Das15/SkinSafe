import os
from flask import Flask, request, jsonify
import numpy as np
from PIL import Image
import io

app = Flask(__name__)

# Dummy model that always returns 69.0 as the confidence score
class DummyModel:
    def predict(self, image_array):
        return np.array([[69.0] * 5])  # Assuming 5 classes

# Initialize model
try:
    model = DummyModel()
except Exception as e:
    model = None
    print(f"Error loading model: {e}")

# Home route
@app.route('/')
def home():
    return "Welcome to the TeleDerm Backend!"

# Favicon route
@app.route('/favicon.ico')
def favicon():
    return '', 204

# Predict route (POST request for image upload and analysis)
@app.route('/predict', methods=['POST'])
def predict():
    if model is None:
        return jsonify({"error": "Model is not loaded or unavailable"}), 500

    if 'image' not in request.files:
        return jsonify({"error": "No image provided"}), 400

    image_file = request.files['image']
    image = Image.open(io.BytesIO(image_file.read()))

    # Preprocess the image
    image = image.resize((224, 224))
    image_array = np.array(image) / 255.0
    image_array = np.expand_dims(image_array, axis=0)

    # Predict
    predictions = model.predict(image_array)
    predicted_class = np.argmax(predictions, axis=1)[0]

    return jsonify({"predicted_class": str(predicted_class), "predictions": predictions.tolist()})

# Route to check model status
@app.route('/status', methods=['GET'])
def status():
    return jsonify({"status": "Model is loaded and ready"} if model else {"status": "Model is not loaded or unavailable"}, 500)

# Fetch prediction results (GET request)
@app.route('/get_results/<int:image_id>', methods=['GET'])
def get_results(image_id):
    # Simulated response (Modify based on database implementation)
    return jsonify({"image_id": image_id, "predicted_class": "2", "confidence_score": 69.0})

# Upload model (POST request)
@app.route('/upload_model', methods=['POST'])
def upload_model():
    file = request.files.get('model_file')
    if not file:
        return jsonify({"error": "No file uploaded"}), 400

    try:
        file_path = os.path.join('models', 'new_model.h5')
        file.save(file_path)

        global model
        model = DummyModel()  # Replace with actual model loading
        return jsonify({"message": "Model uploaded and loaded successfully!"})
    except Exception as e:
        return jsonify({"error": f"Error loading model: {str(e)}"}), 500

# Health check route
@app.route('/health', methods=['GET'])
def health():
    return jsonify({"status": "OK"}), 200

if __name__ == "__main__":
    if not os.path.exists('models'):
        os.makedirs('models')

    app.run(debug=True)
